# 회귀분석 07 - 일반화선형모형 II: 로지스틱 회귀모형

---

## 목차

**I. 로지스틱 회귀의 기초 개념**
1. [승산과 승산비의 정의](#1-승산비odds-ratio와-상대위험도relative-risk-그리고-사례-대조-연구)
2. [상대위험도와 그 응용](#2-상대위험도와-그-응용)
3. [사례-대조 연구 설계](#3-사례-대조-연구-설계)

**II. 로지스틱 회귀모형의 이해와 해석**
1. [로지스틱 회귀의 특성과 가정](#4-로지스틱-회귀의-특성과-가정)
2. [로지스틱 회귀식과 해석](#5-로지스틱-회귀식과-해석)
3. [회귀계수와 승산비 해석](#6-회귀계수와-승산비-해석)

**III. 로지스틱 회귀모형의 활용과 평가**
1. [모형 적합과 추정 방법](#7-모형-적합과-추정-방법)
2. [분류 정확도 평가](#8-분류-정확도-평가)
3. [강력한 예측 모형 구축 전략](#9-강력한-예측-모형-구축-전략)

---

## I. 승산비와 상대위험도 분석

### 1. 승산과 승산비의 기본 개념

- **2x2 분할표의 확률분포 예시**:
    
    
    | 위험인자 (X) | 질병 발생 (Y=1) | 질병 미발생 (Y=0) |
    | --- | --- | --- |
    | 노출 (X=1) | $\pi_1$ | $1-\pi_1$ |
    | 미노출 (X=0) | $\pi_0$ | $1-\pi_0$ |
    - $\pi_i = P(Y=1|X=i)$: 위험인자 X가 i일 때 질병이 발생할 확률 (발생률).
- **승산 (Odds)**:
    - $X=i$일 때 성공(질병 발생)할 승산: $\text{Odds}_i = \frac{\text{성공확률}}{\text{실패확률}} = \frac{\pi_i}{1-\pi_i}$
- **승산비 (Odds Ratio, OR)**:
    - $X=0$(미노출)에 대한 $X=1$(노출)일 때의 승산비:
    $OR = \frac{\text{Odds}_1}{\text{Odds}_0} = \frac{\pi_1/(1-\pi_1)}{\pi_0/(1-\pi_0)} = \frac{\pi_1(1-\pi_0)}{\pi_0(1-\pi_1)}$
- **승산비 해석**:
    - $OR = 1 \iff \pi_1 = \pi_0$ (노출 여부와 질병 발생은 무관)
    - $OR > 1 \iff \pi_1 > \pi_0$ (노출 시 질병 발생 승산이 더 높음)
    - $OR < 1 \iff \pi_1 < \pi_0$ (노출 시 질병 발생 승산이 더 낮음)
    - 예: $OR = 2$ 이면, 위험인자에 노출된 그룹의 질병 발생 승산이 미노출 그룹의 승산보다 2배 높다.

### 2. 상대위험도의 정의와 해석

- **정의**:
    - $X=0$(미노출)에 대한 $X=1$(노출)일 때의 상대위험도:
    $RR = \frac{P(Y=1|X=1)}{P(Y=1|X=0)} = \frac{\pi_1}{\pi_0}$
- **상대위험도 해석**:
    - $RR = 2$ 이면, 위험인자에 노출된 그룹의 질병 발생률(확률)이 미노출 그룹의 발생률보다 2배 높다. (직관적인 해석 가능)

### 3. 승산비와 상대위험도의 비교와 관계

- **발생률이 매우 낮을 때 ($\pi_0 \approx 0, \pi_1 \approx 0$)**:
    - $1-\pi_0 \approx 1$ 이고 $1-\pi_1 \approx 1$ 이므로,
    - $OR = \frac{\pi_1(1-\pi_0)}{\pi_0(1-\pi_1)} \approx \frac{\pi_1}{\pi_0} = RR$
    - 즉, **질병 발생률이 매우 낮으면 승산비(OR)는 상대위험도(RR)의 근사치**로 사용될 수 있습니다.
- **승산비(OR)의 중요한 성질 (대칭성)**:
    - $OR = \frac{P(Y=1|X=1)P(Y=0|X=0)}{P(Y=1|X=0)P(Y=0|X=1)} = \frac{P(X=1|Y=1)P(X=0|Y=0)}{P(X=1|Y=0)P(X=0|Y=1)}$
    - 즉, 반응변수(Y)와 설명변수(X)의 역할을 바꾸어 계산해도 동일한 승산비 값을 얻습니다.
        - $\pi'_i = P(X=1|Y=i)$ (질병 상태 $i$일 때 위험인자에 노출되었을 확률)
        - $OR = \frac{\pi'_1(1-\pi'_0)}{\pi'_0(1-\pi'_1)}$
    - 이 성질은 **사례-대조 연구(Case-Control Study)**에서 매우 중요합니다.

## II. 연구설계와 회귀모형 활용

### 4. 사례-대조 연구와 로지스틱 회귀

- **사례-대조 연구**: 질병이 있는 그룹(사례군, Case)과 질병이 없는 그룹(대조군, Control)을 먼저 선정한 후, 과거의 위험인자 노출 여부를 조사하는 후향적 연구 방법.
    - 코호트 연구(전향적 연구)와 달리 질병 발생률($\pi_i$)을 직접 추정하기 어렵습니다.
    - 대신, 각 그룹(사례군, 대조군)에서의 위험인자 노출률($\pi'_i$)을 추정할 수 있습니다.
- **사례-대조 연구에서 승산비 추정**:
    - $\hat{OR} = \frac{\hat{\pi}'_1(1-\hat{\pi}'_0)}{\hat{\pi}'_0(1-\hat{\pi}'_1)}$를 통해 코호트 연구에서 얻을 수 있는 $OR = \frac{\pi_1(1-\pi_0)}{\pi_0(1-\pi_1)}$을 추정할 수 있습니다.
- **상대위험도 추정**:
    - 사례-대조 연구에서 RR을 직접 추정하는 것은 불가능합니다.
    - 그러나 **질병 발생률이 매우 낮다는 가정 (Rare Disease Assumption)** 하에서는 $OR \approx RR$이므로, 사례-대조 연구에서 추정된 OR을 RR의 근사치로 해석할 수 있습니다.
- **예제: 폐암과 흡연의 사례-대조 연구**:
    - 폐암환자(사례군) 709명, 비폐암환자(대조군) 709명 대상 흡연 경험 조사.
    - 주요 목적: 흡연에 따른 폐암 발생의 상대위험도(RR) 추정.
    - 사례-대조 연구이므로, 흡연군과 비흡연군에서 폐암 발생률($\pi_i$) 직접 추정 불가.
    - 대신 폐암환자군과 비폐암환자군에서의 흡연 경험률($\pi'_i$) 추정 가능.
        
        
        |  | 흡연 (X=1) | 비흡연 (X=0) | 합계 |
        | --- | --- | --- | --- |
        | 폐암 (Y=1) | 688 | 21 | 709 |
        | 비폐암 (Y=0) | 650 | 59 | 709 |
    - $\hat{\pi}'_1 = P(X=1|Y=1) = 688/709$
    - $\hat{\pi}'_0 = P(X=1|Y=0) = 650/709$
    - $\hat{OR} = \frac{(688/709) \times (1 - 650/709)}{(650/709) \times (1 - 688/709)} = \frac{688 \times 59}{650 \times 21} \approx 2.974$
    - **해석**: 폐암 발생률이 낮다고 가정하면, 흡연은 폐암 발생률을 약 2.974배 증가시킨다고 추론 가능 ($OR \approx RR$).

### 5. 사례-대조 연구의 회귀모형 해석

- **문제점**: 사례-대조 연구는 반응변수 Y(질병 발생 여부)를 기준으로 표본을 추출하므로, 일반적인 로지스틱 회귀모형의 반응변수 Y를 그대로 사용하기 어렵습니다. (Y가 관측된 결과이지, 확률과정이 아님)
- **로지스틱 회귀모형 적용**:
    1. **반응변수 설정**: $Y=1$(사례군, 예: 폐암), $Y=0$(대조군, 예: 비폐암).
    2. **선형예측자**: $\eta = \beta_0 + \beta_1 x$ (x는 위험인자, 예: 흡연 여부).
    3. **연결함수**: $\log\left(\frac{\pi}{1-\pi}\right) = \beta_0 + \beta_1 x$, 여기서 $\pi = P(Y=1|X=x)$ (실제로는 $P(Y=1|\text{표본추출, } X=x)$).
- **계수 해석**:
    - $\hat{\beta}_1$: **적절한 조건 하에서 (x와 표본추출 과정이 서로 무관할 때)**, $x$가 1단위 증가할 때의 **승산비(OR)**로 해석 가능.
    - $\hat{\beta}_0$: 추론의 의미를 부여하기 어려움 (표본추출 방식에 영향 받음).
- **예제: 식도암 사례-대조 연구 (R `esoph` 데이터셋)**
    - 반응변수(Y): 식도암 여부 (1=사례, 0=대조).
    - 설명변수: 나이(agegp), 음주량(alcgp), 흡연량(tobgp) - 모두 범주형.
    - **로지스틱 회귀모형 적용**:
        1. **반응변수 분포**: $Y \sim Bernoulli(\pi)$.
        2. **선형예측자**: 각 설명변수의 범주에 대해 가변수 생성. $\eta = \beta_0^* + \beta_1 x_1 + \dots + \beta_{11} x_{11}$. (각 설명변수의 첫 번째 범주를 기준범주로 설정)
        3. **연결함수**: $\log\left(\frac{\pi(x)}{1-\pi(x)}\right) = \beta_0^* + \beta_1 x_1 + \dots + \beta_{11} x_{11}$.
    - **R 코드 및 결과 해석**:
        - 데이터 준비: `esoph` 데이터셋을 분석 가능한 형태로 변환. (사례/대조군 구분, 가변수 생성 등)
        - 로지스틱 모형 적합: `glm(Y ~ agegp + alcgp + tobgp, family=binomial(link="logit"), data=esoph_data)`
        - **모형 유의성 검정**: 영 이탈도와 잔차 이탈도의 차이를 이용한 가능도비 검정. p-값이 매우 작으므로 모형 유의.
        - **모형 적합도 평가**:
            - 잔차 이탈도 / 잔차 자유도 $\approx 1$ 이면 적합도 양호. (예: 82.337 / 76 $\approx$ 1.083)
            - 잔차 그림 (Q-Q plot 등) 확인. 직선에 가까우면 적합도 양호.
        - **회귀계수 추정값 해석 (예: `n.alcgp40-79` 계수 $\hat{\beta} = 1.435$)**:
            - 나머지 변수(흡연량, 나이)가 같을 때, 기준범주(음주량 0-39g/day)군에 비해 음주량 40-79g/day군의 식도암 발생 승산이 $e^{1.435} \approx 4.20$배 높다 (95% CI: 2.60 ~ 6.95).
    - **해석 간결성 제고: 범주의 단순화**:
        - 설명변수의 범주가 너무 많으면 해석이 복잡해지므로, 유사한 범주들을 통합하여 단순화할 수 있습니다.
        - 예: 나이의 세 범주를 '54+'로 통합, 흡연량의 두 범주를 '10-29g/day'로 통합.
        - **범주 단순화의 적합성 검정**: 단순화 전 모형(완전모형)과 단순화 후 모형(축소모형)을 가능도비 검정으로 비교.
            - $H_0$: 범주를 단순화한 모형이 적절하다.
            - p-값이 크면 $H_0$를 기각하지 못하므로, 간결성의 원칙에 따라 단순화된 모형을 선택할 수 있음. (예: p=0.136)

### 6. 다항 로짓 모형 (Multinomial Logit Model): 기준범주 로짓모형

- **목적**: 반응변수 $Y$의 범주가 **3개 이상이고 명목형(nominal)**일 때 사용.
- **GLM 구성성분**:
    1. **반응변수 분포**: **다항분포 (Multinomial Distribution)**.
        - $J$: $Y$가 가질 수 있는 범주의 수.
        - $\pi_j = P(Y=j)$: $j$번째 범주에 속할 확률, $\sum_{j=1}^{J} \pi_j = 1$.
        - $n_j$: $j$번째 범주에 속하는 관측 도수, $\sum n_j = n$ (총 관측 수).
    2. **선형예측자**: $\eta_j = \beta_{0j} + \beta_{1j}x_1 + \dots + \beta_{pj}x_p$. (각 로짓에 대해 다른 계수 세트)
    3. **연결함수: 기준범주 로짓 (Baseline-Category Logit)**
        - $Y$의 마지막 범주 $J$를 **기준범주(Reference Category)**로 설정.
        - $\log\left(\frac{\pi_j}{\pi_J}\right) = \beta_{0j} + \beta_{1j}x_1 + \dots + \beta_{pj}x_p$, for $j = 1, 2, \dots, J-1$.
        - 총 $J-1$개의 로짓 방정식을 동시에 고려.
- **기준범주 로짓모형의 이해 (설명변수 $x$ 하나인 경우)**:
    - $\log\left(\frac{\pi_j}{\pi_J}\right) = \beta_{0j} + \beta_{1j}x$
    - 각 범주 $j$에 속할 확률 $\pi_j(x)$:
        - $\pi_j(x) = \frac{\exp(\beta_{0j} + \beta_{1j}x)}{1 + \sum_{l=1}^{J-1} \exp(\beta_{0l} + \beta_{1l}x)}$, for $j=1, \dots, J-1$.
        - $\pi_J(x) = \frac{1}{1 + \sum_{l=1}^{J-1} \exp(\beta_{0l} + \beta_{1l}x)}$.
    - 임의의 두 범주 쌍 $(k, l)$에 대한 로그 승산비:
        - $\log\left(\frac{\pi_k}{\pi_l}\right) = \log\left(\frac{\pi_k/\pi_J}{\pi_l/\pi_J}\right) = (\beta_{0k} - \beta_{0l}) + (\beta_{1k} - \beta_{1l})x$.
    - **계수 $\beta_{1j}$의 의미**: $x$가 1단위 증가할 때, 기준범주 $J$에 비해 특정 범주 $j$에 속할 승산의 비(Odds Ratio)가 $e^{\beta_{1j}}$ 배로 변함.
- **예제: 세 종류 학습프로그램 선택 (R `UPG` 라이브러리 `program` 데이터)**
    - 반응변수(Y): 프로그램 종류 (general, academic, vocational) - `general`을 기준범주로 설정.
    - 설명변수: 사회경제적 상태(ses: low, middle, high), 쓰기점수(write: 표준화 점수).
    - **다항로짓모형 설정**:
        - $\log\left(\frac{\pi_j}{\pi_3}\right) = \beta_{0j} + \beta_{1j}x_1 + \beta_{2j}x_2 + \beta_{3j}x_3$, for $j=1 (\text{academic}), 2 (\text{vocation})$. ($\pi_3$는 general)
        - $x_1$: ses=middle (1 or 0), $x_2$: ses=high (1 or 0) (ses=low가 기준), $x_3$: 쓰기점수.
    - **R 코드 및 결과 (nnet 패키지 `multinom()` 함수 사용)**:
        - 모형 적합 후, 각 로짓('academic' vs 'general', 'vocation' vs 'general')에 대한 회귀계수 추정치 확인.
        - **계수 해석 (예: 쓰기점수($x_3$) 회귀계수)**:
            - 'academic' 로짓의 $\hat{\beta}_{31} = 0.549 \Rightarrow e^{0.549} \approx 1.732$. 쓰기점수 1점 증가 시 'general'보다 'academic' 선택 승산 1.732배 증가.
            - 'vocation' 로짓의 $\hat{\beta}_{32} = -0.528 \Rightarrow e^{-0.528} \approx 0.590$. 쓰기점수 1점 증가 시 'general'보다 'vocation' 선택 승산 0.590배 (즉, 41% 감소).
        - 승산비 및 95% 신뢰구간 계산.
    - **모형 유의성 검정**:
        - $H_0$: 모든 설명변수의 계수가 0이다 (절편만 있는 모형).
        - 가능도비 검정 결과 p-값이 매우 작으므로 모형 유의.
    - **개별 설명변수의 유의성 검정 (예: 'ses'의 유의성)**:
        - 'ses' 변수를 제외한 모형과 전체 모형을 가능도비 검정으로 비교.
        - p-값이 유의수준(예: 0.05)보다 작으면 해당 변수 유의. (예: p=0.026)
    - **설명변수가 주어졌을 때 각 프로그램 선택 확률 추정**:
        - 적합된 모형을 사용하여 각 범주에 속할 확률 계산.
        - **시각화**: 사회경제적 상태별로 쓰기점수에 따른 각 프로그램 선택 확률 변화 곡선.
            - 주요 특징: 쓰기점수가 높아질수록 'academic' 선택 확률 증가, 'vocation' 선택 확률 감소. 'general'은 증가하다 감소. 'high' 군에서 이러한 경향성이 더 강하게 나타남.

---
## III. 로지스틱 회귀모형의 활용과 평가

---

### 7. 모형 적합과 추정 방법

### 8. 분류 정확도 평가

- **목적**: 반응변수 $Y$가 취할 수 있는 값이 개수(0, 1, 2, ...)일 때, 이 개수의 평균($\mu$)을 모델링합니다.
- **GLM 구성성분**:
    1. **반응변수 $Y$의 확률분포**: **포아송 분포 (Poisson Distribution)** 가정. $Y \sim Poisson(\mu)$, $0 < \mu$.
        - 포아송 분포는 단위 시간 또는 단위 공간 내에서 발생하는 사건의 횟수를 모델링하는 데 사용됩니다. $E(Y) = \mu$, $Var(Y) = \mu$.
    2. **선형예측자 ($\eta$)**: 설명변수 $x_1, \dots, x_p$에 대해 $\eta = \beta_0 + \beta_1 x_1 + \dots + \beta_p x_p$.
    3. **연결함수**: **로그 연결함수 (Log Link)**. (포아송 분포의 정준연결)
        - $\eta = g(\mu) = \log(\mu)$.
    - **모형식**: $\log(\mu) = \beta_0 + \beta_1 x_1 + \dots + \beta_p x_p$.
- **로그선형모형의 특성: 평균에 대한 승법모형 (Multiplicative Model for Mean)**
    - $\mu = \exp(\beta_0 + \beta_1 x_1 + \dots + \beta_p x_p) = e^{\beta_0} e^{\beta_1 x_1} \dots e^{\beta_p x_p}$.
    - **회귀계수 $\beta_i$의 해석**:
        - 다른 변수들이 일정할 때, $x_i$가 1단위 증가하면 평균 $\mu$는 $e^{\beta_i}$ 배로 변합니다.
        - $\frac{\mu_{i+}}{\mu} = e^{\beta_i}$, 즉 $\mu_{i+} = \mu \times e^{\beta_i}$.
        - $e^{\beta_i}$는 $x_i$가 1단위 증가할 때 평균의 **변화율(Rate Ratio 또는 Incidence Rate Ratio, IRR)**을 나타냅니다.
- **예제: 자동차 사고건 수 자료 (R `MASS` 라이브러리 `Traffic` 데이터)**
    - 반응변수 $Y$: 자동차 사고건수 (y)
    - 설명변수: 속도제한 강제 여부(limit: 1=강제, 0=미강제), 조사 수집 일(day: 92개 범주), 조사 수집 년도(year: 1961, 1962)
    - **로그선형모형 설정**:
        1. $Y \sim Poisson(\mu)$.
        2. $\eta = \beta_0 + \beta_{\text{limit}} x_{\text{limit}} + \sum \beta_{\text{day}*j} x*{\text{day}*j} + \beta*{\text{year}} x_{\text{year}}$. (day는 가변수 처리)
        3. $\log(\mu) = \eta$.
    - **R 코드 및 결과 해석**:
        - `glm(y ~ limit + factor(day) + factor(year), family=poisson(link="log"), data=Traffic)`
        - 기준범주: limit='no', day='1', year='1961'.
        - **모형 유의성 및 적합결여 검정**:
            1. **모형 유의성 (Overall Model Significance)**: 영 이탈도와 잔차 이탈도의 차이를 이용한 가능도비 검정. p-값이 매우 작으므로 모형 유의. (예: $LR \approx 518.14$, $df=93$, $p < 0.0001$)
            2. **모형 적합결여 (Goodness-of-fit)**: 잔차 이탈도 분석.
                - 잔차이탈도 / 자유도 비율 확인: $107.11 / 90 \approx 1.19$. (1에 가까우면 적합도 양호)
                - 적합결여 검정 (잔차 이탈도를 $\chi^2$ 분포와 비교): $LR \approx 107.11$, $df=90$, $p \approx 0.105$. (유의수준 0.05에서 기각하지 못하므로 적합결여가 심각하지 않다고 볼 수 있음)
        - **변수선택**: `stepAIC()` 등을 사용하여 변수 선택 가능. (예시에서는 `year` 변수가 제거됨)
        - **선택된 모형의 유의성 및 적합결여 검정**: 유사한 방식으로 수행.
        - **선택된 모형에서 `day` 변수의 유의성 검정**:
            - $H_0: \log(\mu) = \beta_0 + \beta_{\text{limit}}x_{\text{limit}}$ vs $H_1: \log(\mu) = \beta_0 + \beta_{\text{limit}}x_{\text{limit}} + \sum \beta_{\text{day}*j}x*{\text{day}_j}$
            - 가능도비 검정 결과 p-값이 매우 작으므로 `day` 변수는 매우 유의함.
        - **추정된 회귀계수의 해석 (예: `limit`yes 계수 $\hat{\beta}_{\text{limit}} = -0.296$)**:
            - $\mu_0$: 특정일에 속도제한을 하지 않았을 때의 사고 건수 평균.
            - $\mu_1$: 같은 특정일에 속도제한을 했을 때의 사고 건수 평균.
            - $\log(\frac{\hat{\mu}_1}{\hat{\mu}*0}) = \hat{\beta}*{\text{limit}} = -0.296$.
            - $\frac{\hat{\mu}_1}{\hat{\mu}_0} = e^{-0.296} \approx 0.744$.
            - 해석: 다른 조건이 동일할 때, 속도제한을 실시하면 교통사고 발생 건수 평균이 미실시 경우의 약 74.4% 수준으로 감소합니다 (즉, 약 25.6% 감소).
        - **$e^{\beta_i}$ 추정값과 95% 신뢰구간**: `exp(coef(model))`, `exp(confint(model))` 등을 사용.
            - 예: $e^{\hat{\beta}_{\text{limit}}}$의 95% CI: (0.688, 0.804).
        - **잔차분석**: Q-Q plot 등으로 잔차의 정규성(또는 다른 분포 가정) 검토. 포아송 회귀에서는 이탈도 잔차나 Pearson 잔차의 분포를 확인.

### 9. 강력한 예측 모형 구축 전략

- **율(Rate) 자료의 특성**:
    - 관심 사건의 발생률($\lambda$)이 아주 작은 경우, 전체 관측도수($N$, 노출량, 시간 등)가 매우 커야 의미 있는 사건의 수($Y$)를 관측할 수 있습니다.
    - $Y$: 관심 사건 발생 수, $\lambda$: 발생률, $N$: 전체 관측도수(노출량).
    - $Y \sim Binomial(N, \lambda)$ 로 볼 수 있으나, $N$이 매우 크고 $\lambda$가 매우 작으면 $N\lambda = \mu$ (상대적으로 작은 값)로 고정될 때, $Y \approx Poisson(\mu)$로 근사할 수 있습니다.
- **율 자료에 대한 로그선형모형의 GLM 구성성분**:
    1. **반응변수 $Y$의 확률분포**: **포아송 분포** 가정. $Y \sim Poisson(N\lambda)$. (평균 $\mu = N\lambda$)
    2. **선형예측자 ($\eta$)**: $\eta = \beta_0 + \beta_1 x_1 + \dots + \beta_p x_p$.
    3. **연결함수**: **로그 연결함수** 사용.
        - $\log(E(Y)) = \log(N\lambda) = \log(N) + \log(\lambda)$.
        - $\log(N) + \log(\lambda) = \beta_0 + \beta_1 x_1 + \dots + \beta_p x_p$.
        - 따라서, **율($\lambda$)에 대한 모형**: $\log(\lambda) = \beta_0 + \beta_1 x_1 + \dots + \beta_p x_p - \log(N)$.
        - 일반적으로는 $\log(E(Y)) = \log(N) + \beta_0 + \beta_1 x_1 + \dots + \beta_p x_p$ 형태로 두고, $\log(N)$을 **상쇄항(Offset)**으로 처리합니다.
            - 모형식: $\log(\mu) = \text{offset}(\log N) + \beta_0 + \beta_1 x_1 + \dots + \beta_p x_p$.
            - 이는 $\log(\frac{\mu}{N}) = \log(\lambda) = \beta_0 + \beta_1 x_1 + \dots + \beta_p x_p$ 와 동일합니다.
- **예제: 나이 지역별 흑색종 발생자료**:
    - `cases`: 흑색종 발생 수 ($Y$)
    - `total`: 전체 관측 도수 ($N$)
    - 설명변수: `age` (나이 구분), `region` (거주지역: 1=south, 0=north)
    - **로그선형모형 설정**:
        1. $Y \sim Poisson(N\lambda)$.
        2. $\eta = \beta_0 + \sum \beta_{\text{age}*j} x*{\text{age}*j} + \beta*{\text{region}} x_{\text{region}}$. (age는 가변수 처리)
        3. $\log(\lambda) = \eta$. (또는 $\log(E(Y)) = \text{offset}(\log N) + \eta$)
    - **R 코드 및 분석 결과**:
        - `glm(cases ~ factor(age) + factor(region) + offset(log(total)), family=poisson(link="log"), data=melanoma_data)`
        - **모형 유의성 및 적합결여 검정**:
            1. 모형 유의성 (LRT): p-값이 매우 작으므로 모형 유의. (예: $LR \approx 889.6$, $df=6$, $p < 0.0001$)
            2. 모형 적합결여 (잔차 이탈도): 잔차이탈도/자유도 $\approx 1.243$. 적합결여검정 p-값 $\approx 0.286$. (적합도 양호)
        - **추정된 회귀계수의 해석 (예: `region`south 계수 $\hat{\beta}_{\text{region}} = 0.819$)**:
            - $e^{\hat{\beta}_{\text{region}}} = e^{0.819} \approx 2.269$.
            - 해석: 다른 조건(나이대)이 동일할 때, 남쪽지역(south)의 흑색종 발생률($\lambda$)은 북쪽지역(north)보다 약 2.269배 높은 것으로 추정됩니다 (95% CI: 1.973, 2.607).

## IV. 모형의 확장과 응용

### 10. 과대산포 현상과 대처

### 11. 준가능도 방법론

### 12. 고급 회귀모형 응용 사례

- **과대산포란?**:
    - GLM에서 가정한 확률분포의 분산보다 **실제 자료의 분산이 더 크게 나타나는 현상**.
    - **예시**:
        - **포아송 분포 가정 시**: $E(Y)=\mu$, $Var(Y)=\mu$.
            - 실제 자료에서 $Var(Y) = \phi\mu$ 이고 $\phi > 1$ 이면 과대산포.
        - **베르누이/이항 분포 가정 시**: $E(Y)=\pi$ (또는 $n\pi$), $Var(Y)=\pi(1-\pi)$ (또는 $n\pi(1-\pi)$).
            - 실제 자료에서 $Var(Y) = \phi\pi(1-\pi)$ 이고 $\phi > 1$ 이면 과대산포.
    - $\phi$: **산포모수 (Dispersion Parameter)**.
- **GLM에서 과대산포 발생 시 문제점**:
    - 모수 추정값($\hat{\beta}_i$) 자체는 여전히 일치성(consistency)을 가질 수 있으나,
    - **표준오차를 과소 추정**하게 되어, 모수의 **유의성을 과대평가**하게 됩니다 (t-값 또는 z-값이 커지고 p-값이 작아짐).
    - 평균모형을 개선(변수 추가, 교호작용 등)하여도 과대산포가 제거되지 않으면 (즉, 잔차이탈도가 잔차자유도에 비해 과도하게 크면) 과대산포를 추론에 반영해야 합니다.
- **GLM에서 과대산포를 반영하는 방법: 준가능도 (Quasi-likelihood) 함수 (Wedderburn, 1974)**
    - 반응변수의 완전한 확률분포를 명시하는 대신, **평균과 분산 간의 관계 (분산함수 $V(\mu)$)만을 가정**하여 모수를 추정하는 방법입니다.
    - 준가능도 함수 $Q(\mu; y) = \int_{y}^{\mu} \frac{y-t}{\phi V(t)} dt$.
    - $Var(Y) = \phi V(\mu)$, 여기서 $\phi$는 미지의 산포모수.
    - 준가능도 함수로부터 산포모수 $\phi$의 추정식은 직접 도출되지 않습니다.
    - **산포모수 $\phi$ 추정**: 주로 **일반화 피어슨 카이제곱 통계량 (Generalized Pearson Statistic)**을 이용합니다.
        - $\hat{\phi} = \frac{1}{n-p-1} \sum_{i=1}^{n} \frac{(y_i - \hat{\mu}_i)^2}{V(\hat{\mu}_i)}$. (잔차 자유도로 나눈 값)
        - 이 $\hat{\phi}$ 값을 회귀계수의 표준오차 계산 및 가설검정에 사용합니다. (표준오차가 $\sqrt{\hat{\phi}}$ 배만큼 커짐)
- **예제: 호주 월겟 지역 아이들 결석회수 자료 (R `MASS` 라이브러리 `quine` 데이터)**
    - `Days`: 결석 회수 ($Y$)
    - 설명변수: `Eth`(거주 문화), `Sex`(성별), `Age`(나이), `Lrn`(학습수준)
    - **1단계: 포아송 로그선형모형 적합**:
        - `glm(Days ~ Eth + Sex + Age + Lrn, family=poisson, data=quine)`
        - 결과: 모든 회귀계수가 유의하게 나옴. 그러나 잔차이탈도/자유도 = $1696.7 / 139 \approx 12.2$로 매우 큼 $\Rightarrow$ 심각한 적합결여 또는 과대산포 의심.
    - **2단계: 평균모형 개선 시도 (예: 4차 교호작용 모형)**
        - 교호작용을 추가해도 잔차이탈도/자유도 비율이 여전히 큼 (예: $1173.9 / 118 \approx 9.9$) $\Rightarrow$ 평균모형 개선만으로는 과대산포 제어 불가.
    - **3단계: 과대산포 모형 (포아송 준가능도) 추론**:
        - **설정**:
            1. $Y$의 분포 가정: 포아송 준가능도 함수 ($V(\mu)=\mu$).
            2. 선형예측자: 이전과 동일.
            3. 연결함수: 로그 연결.
        - **R 코드 및 분석결과**:
            - `glm(Days ~ Eth + Sex + Age + Lrn, family=quasipoisson(link="log"), data=quine)`
            - **결과 비교**:
                - 회귀계수 $\hat{\beta}_i$ 추정값은 포아송 로그선형모형과 동일.
                - 잔차 이탈도와 잔차 자유도도 동일.
                - **회귀계수 $\hat{\beta}_i$의 표준오차가 커짐** (추정된 산포모수 $\hat{\phi}$가 곱해지므로).
                - 이에 따라 **회귀계수의 유의확률(p-값)이 변화**함.
            - **과대산포 보정 후 해석**:
                - 이전에는 모든 변수가 유의했지만, 준가능도 모형에서는 `Eth`(거주문화)만 유의하게 나옴.
                - `EthN`(비원주민)의 계수: $\hat{\beta}_{\text{EthN}} = -0.534$.
                - $e^{-0.534} \approx 0.586$.
                - 해석: 다른 조건이 동일할 때, 비원주민(N) 아이들의 결석회수 평균은 원주민(A, 기준범주) 아이들의 약 0.586배로 감소하는 것으로 추정됩니다.

---