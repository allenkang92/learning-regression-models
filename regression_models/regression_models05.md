# 회귀분석 05 - 회귀모형 진단과 평가

---

## 목차

**I. 회귀진단의 기초**
1. [회귀진단의 개념과 중요성](#1-회귀진단-regression-diagnostics)
2. [총괄분석과 개별분석](#2-총괄분석과-개별분석)
3. [모형진단과 자료진단](#3-모형진단과-자료진단)

**II. 잔차분석과 가정검정**
1. [잔차의 정의와 활용](#4-잔차의-정의와-활용)
2. [잔차그림과 해석](#5-잔차그림과-해석)
3. [회귀가정의 검정방법](#6-회귀가정의-검정방법)

**III. 특이점과 영향력 분석**
1. [특이점의 발견과 심각성 평가](#7-특이점의-발견과-심각성-평가)
2. [영향력 측정 방법](#8-영향력-측정-방법)
3. [진단 결과에 따른 조치](#9-진단-결과에-따른-조치)

---

## I. 회귀진단의 기초

### 1. 회귀진단의 개념과 중요성

- **총괄분석 (Aggregate Analysis) vs. 개별분석 (Case Analysis)**:
    - **총괄분석**: 전체 자료를 사용하여 회귀식을 구하고, 회귀계수를 추정하며, 모형의 유의성 등을 검정하는 과정. (이전 강의들에서 다룬 내용)
        - 이는 설정된 회귀모형과 관련 가정들(선형성, 등분산성, 정규성, 오차의 독립성 등)이 **정확하다는 전제** 하에 이루어집니다.
    - **회귀진단**: 총괄분석 이후에 수행되는 중요한 과정으로, 사용된 회귀모형 및 가정이 타당한지를 진단하고, 각각의 관측값이 모형 및 가정에 어떠한 영향을 미치는지를 평가합니다.
        - **개별분석**이라고도 불립니다.
- **회귀진단의 두 가지 주요 측면**:
    - **모형진단 (Model Diagnostics)**: 적합된 회귀모형이나 회귀분석의 기본 가정에 어떤 문제점이 있는지를 파악합니다. (예: 선형성 위배, 이분산성, 오차의 정규성 위배 등)
    - **자료진단 (Data Diagnostics)**: 자료의 작은 변화(예: 특정 관측값의 포함 또는 제외)가 모형의 추정에 어떠한 영향을 미치는지를 파악합니다. (예: 특이점, 영향력 있는 관측값 식별)

### 2. 총괄분석과 개별분석

### 3. 모형진단과 자료진단

## II. 잔차분석과 가정검정

### 4. 잔차의 정의와 활용

- **잔차 (Residuals)**:
    - 실제 관측값($Y_i$)과 회귀모형에 의한 예측값($\hat{Y}_i$) 사이의 차이: $e_i = Y_i - \hat{Y}_i$.
    - 잔차는 모형이 데이터를 얼마나 잘 설명하는지, 그리고 회귀 가정이 만족되는지를 평가하는 데 사용되는 중요한 정보입니다.
- **잔차의 표준화 (Standardization of Residuals)**:
    - 단순 잔차($e_i$)는 각 관측점에서의 분산이 다를 수 있어 직접 비교하기 어렵습니다. 따라서 표준화를 통해 비교 가능한 형태로 만듭니다.
    - **표준화 잔차 (Standardized Residuals, $r_i$)**:
        - $r_i = \frac{e_i}{\sqrt{MSE(1-h_{ii})}}$ (일부 교재에서는 $r_i = \frac{e_i}{\sqrt{MSE}}$로 단순화하기도 함)
        - $MSE$: 잔차평균제곱
        - $h_{ii}$: 햇 행렬(Hat Matrix, $\mathbf{H} = \mathbf{X}(\mathbf{X}^T \mathbf{X})^{-1} \mathbf{X}^T$)의 i번째 대각 원소 (레버리지 값). $0 < h_{ii} < 1$.
        - 평균이 0이고 분산이 약 1인 분포를 따릅니다.
    - **스튜던트화 잔차 (Studentized Residuals, $t_i$)**:
        - $t_i = \frac{e_i}{\sqrt{MSE_{(i)}(1-h_{ii})}}$
        - $MSE_{(i)}$: i번째 관측값을 **제외하고** 적합한 모형의 잔차평균제곱 (Deletion Residual).
        - 특정 관측값 자신이 잔차 분산 추정에 미치는 영향을 제거하여, 해당 관측값이 특이점인지 판단하는 데 더 민감합니다.
        - 자유도가 $n-k-1-1 = n-k-2$인 t-분포를 따릅니다.
- **표준화잔차와 스튜던트화 잔차의 관계**:
    - 스튜던트화 잔차는 표준화 잔차보다 일반적으로 절댓값이 더 크게 나타나는 경향이 있어, 특이점을 탐지하는 데 더 효과적일 수 있습니다.

### 5. 잔차그림과 해석

### 6. 회귀가정의 검정방법

## III. 특이점과 영향력 분석

### 7. 특이점의 발견과 심각성 평가

- **특이점의 정의**:
    - 대부분의 자료가 따르는 회귀모형에서 **상당히 벗어난 관측값**.
    - 주어진 모형을 잘 따르지 않는 이상한 점(Anomalous Observation)으로, **이상점**이라고도 불립니다.
    - 자료진단의 중요한 목표 중 하나는 이러한 특이점을 찾아내는 것입니다.
- **특이점의 검출**:
    - 주로 **스튜던트화 잔차**를 이용합니다.
    - 일반적으로 스튜던트화 잔차의 절댓값이 2 또는 3보다 크면 특이점으로 의심합니다.
    - **본페로니 t-검정 (Bonferroni t-test)**: 다중 비교 문제를 보정하여 특이점을 검정하는 통계적인 방법. (개별 t-검정의 유의수준 $\alpha$를 관측값 수 $n$으로 나눈 $\alpha/n$을 사용)
- **R 사용: Forbes 자료 예제 (특이점 진단)**:
    - **자료 설명**: Forbes는 물 끓는 온도(temp)와 대기압력에 로그를 취한 값(Lpress = 100*log10(press)) 사이에 선형 관계가 있다고 주장.
    - 데이터 로드 및 변수 생성: `forbes = read.csv("c://data/reg/forbes.csv")`, `forbes$Lpress = 100*log10(forbes$press)`
    - 산점도 확인 및 특이점 의심: `plot(forbes$temp, forbes$Lpress, pch=19)`, `identify(...)` (12번째 관측점이 눈에 띄게 벗어남)
    - **모형 적합**: `forbes_lm = lm(Lpress ~ temp, data=forbes)`
    - `summary(forbes_lm)`: R-squared가 매우 높고 (0.995), F-통계량도 매우 큼. 전반적으로 모형이 좋아 보임.
    - `anova(forbes_lm)`: 분산분석표 확인.
    - **잔차 분석 (`ls.diag` 함수 사용)**:
        - `forbes_res = ls.diag(forbes_lm)`: 회귀진단에 필요한 다양한 통계량 계산.
        - `names(forbes_res)`: 계산된 통계량 목록 확인 (`std.res`, `stud.res`, `hat`, `cooks` 등).
        - `resid_result = cbind(forbes_res$std.res, forbes_res$stud.res, forbes_res$hat)`: 표준화 잔차, 스튜던트화 잔차, 햇 값(레버리지) 결합.
        - 결과 출력: 12번째 관측값의 스튜던트화 잔차가 `12.374`로 매우 큼.
        - `rstudent(forbes_lm)`: 스튜던트화 잔차만 직접 계산.
    - **특이값 검정 (Bonferroni p-value)**:
        - 12번째 관측값에 대한 본페로니 p-값 계산: `2*17*(1-pt(12.374,14))` (자유도는 n-k-1-1 = 17-1-1-1 = 14) $\approx$ `1.07e-07` (매우 작음)
        - `library(car)` 패키지의 `outlierTest(forbes_lm)` 함수 사용:
            - 12번째 관측값의 스튜던트화 잔차(`rstudent`), 보정 전 p-값(`unadjusted p-value`), 본페로니 보정 p-값(`Bonferonni p`) 출력.
            - 본페로니 p-값이 매우 작으므로 12번째 관측값은 유의한 특이점으로 판단.
- **특이점 식별 후 조치**:
    1. **원인 규명**:
        - 자료 입력 오류 (Typo)
        - 실험 과정의 오류
        - 잘못된 원료 사용
        - 측정 기계 고장 등
    2. **조치**:
        - 원인이 밝혀지고 수정 가능하면: **새로운 자료로 대체** (재실험 등).
        - 수정이 불가능하거나 원인 불명이지만 명백한 오류로 판단되면: 해당 **특이점을 제거하고 분석**. (제거 근거 명시 필요)
        - 단순히 모형에 잘 맞지 않는다고 해서 무조건 제거하는 것은 바람직하지 않음. (데이터의 중요한 특성일 수 있음)

### 8. 영향력 측정 방법

### 9. 진단 결과에 따른 조치

- **영향력 있는 관측값 (Influential Observation)**:
    - 해당 관측값을 **모형에서 제외했을 때, 회귀계수 추정치나 예측값 등 모형의 주요 결과에 큰 변화를 초래**하는 관측값.
    - 특이점이면서 동시에 레버리지가 높은 관측값이 영향력이 클 가능성이 높습니다.
    - (Prater 자료 예시 언급)
- **Cook의 D 통계량 (Cook's Distance, $D_i$)**:
    - i번째 관측값이 회귀계수 추정치에 미치는 영향을 측정하는 대표적인 지표.
    - $D_i = \frac{e_i^2 \cdot h_{ii}}{ (k+1) \cdot MSE \cdot (1-h_{ii})^2 }$
    - $D_i$는 스튜던트화 잔차와 레버리지 값을 모두 고려합니다.
    - **판단 기준**:
        - 일반적으로 $D_i > 1$ 이면 영향력이 크다고 간주.
        - 또는 $D_i > \frac{4}{n-k-1}$ 또는 $D_i > \frac{4}{n}$ 을 기준으로 삼기도 함.
        - 다른 $D_j$ 값들에 비해 상대적으로 매우 큰 $D_i$ 값을 가진 관측점을 주목.
- **R 사용: 토양침식자료 예제 (영향력 있는 관측값 진단)**:
    - 데이터 로드: `soil = read.csv("c:/data/reg/soil.csv")`
    - 모형 적합: `soil_lm = lm(SL ~ SG+LOBS+PGC, data=soil)`
    - `summary(soil_lm)`, `anova(soil_lm)`: 모형 요약 및 분산분석표 확인.
    - **잔차 산점도 (적합값 vs. 잔차)**:
        - `plot(soil_lm$fitted, soil_lm$resid, pch=19)`
        - `identify(...)`: 점 클릭하여 인덱스 확인 (예: 7번, 10번 의심)
            - 예측값이 가장 큰 7번이 영향력 있는 관측값, 잔차가 큰 10번이 특이점일 가능성 시사.
    - **잔차 분석 및 Cook 통계량 (`ls.diag` 함수 사용)**:
        - `soil_diag = ls.diag(soil_lm)`
        - `diag_st = cbind(soil_diag$hat, soil_diag$std.res, soil_diag$stud.res, soil_diag$cooks)`: 레버리지($H_{ii}$), 표준화잔차($r_i$), 스튜던트화잔차($t_i$), Cook의 D($D_i$) 결합.
        - 결과 출력:
            - 7번 관측값: $H_{ii}=0.533$, $t_i=3.098$, $D_i=1.227$ (영향력 있는 관측값으로 판단 가능, $D_i > 1$)
            - 10번 관측값: $H_{ii}=0.188$, $t_i=-3.851$ (스튜던트화 잔차 큼 - 특이점 의심), $D_i=0.289$
    - **Cook의 D 통계량 직접 계산 및 확인**:
        - `Di = cooks.distance(soil_lm)`
        - `round(Di, 3)`: 각 관측값의 Cook's D 값 확인.
    - **특이점 검정 (`outlierTest` 함수)**:
        - `library(car)`
        - `outlierTest(soil_lm)`:
            - `No Studentized residuals with Bonferonni p < 0.05` (이 데이터에서는 본페로니 기준 엄격하게 유의한 특이점은 없다고 나옴)
            - `Largest |rstudent|`: 절댓값이 가장 큰 스튜던트화 잔차를 가진 관측값(10번)과 관련 통계량 제시. (10번의 본페로니 p-값은 0.09로 유의수준 0.05에서 기각되지 않음)

---